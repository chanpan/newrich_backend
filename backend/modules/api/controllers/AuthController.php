<?phpnamespace backend\modules\api\controllers;use appxq\sdii\utils\VarDumper;use backend\modules\api\classes\ClsAuth;use backend\modules\api\classes\ClsMember;use common\modules\user\classes\CNAuth;use common\modules\user\models\Profile;use cpn\chanpan\classes\CNMessage;use mdm\admin\models\User;use yii\web\Controller;class AuthController extends Controller{    public function beforeAction($action)    {        $origin = "*";        if (array_key_exists('HTTP_ORIGIN', $_SERVER)) {            $origin = $_SERVER['HTTP_ORIGIN'];        }        header("Access-Control-Allow-Origin: $origin", true);        header("Access-Control-Allow-Headers: Origin,Content-Type,Authorization,x-access-token,application,uuid,version,platform");        $this->enableCsrfValidation = false;        return true;    }    public function actionRegister()    {        $email = \Yii::$app->request->post('email');        $password = \Yii::$app->request->post('password');        $firstname = \Yii::$app->request->post('firstname');        $lastname = \Yii::$app->request->post('lastname');        $member_id = \Yii::$app->request->post('member_id');        $member_type = \Yii::$app->request->post('member_type');        $tel = \Yii::$app->request->post('tel');        $link = \Yii::$app->request->post('link');        $linkCurrent = 'Newrich'.Date('dmYHis').time().rand(1000000,999999999)."(:";        $profile = Profile::find()->where('link=:link',[            ':link' => $link        ])->one();        if(ClsAuth::checkEmail($email)){            return CNMessage::getError("Email {$email} ถูกใช้งานแล้ว");        }        if($profile){//            VarDumper::dump($profile->user_id);            $data = [                'email'=>$email,                'password'=>$password,                'firstname'=>$firstname,                'lastname'=>$lastname,                'name'=>"{$firstname} {$lastname}",                'member_id'=>$member_id,                'linkCurrent'=>$linkCurrent,                'member_type'=>$member_type,                'parent_id'=>$profile->user_id,                'tel'=>$tel            ];            $data = ClsAuth::saveUser($data);            if($data['status'] == 'success'){                return CNMessage::getSuccess("สมัครสมาชิกสำเร็จ");            }else{                return CNMessage::getError("Error กรุณาตรวจสอบข้อมูลของท่าน");            }        }    }    public function actionLogin()    {        $username = \Yii::$app->request->post('username');        $password = \Yii::$app->request->post('password');        $login = ClsAuth::Login($username, $password);        if($login['status']=='success'){            $member = ClsMember::getMemberById($login['data']['id'], true);            return CNMessage::getSuccess("Success", $member);        }else{            return CNMessage::getError("ไม่พบผู้ใช้งาน");        }    }    public function actionGetProfile()    {        $token = \Yii::$app->request->headers->get('x-access-token');        $total = \Yii::$app->request->get('total',true);        $user = ClsAuth::getUserByToken($token);        $member = ClsMember::getMemberById($user->id, true, $total);        return CNMessage::getSuccess("Success", $member);    }}