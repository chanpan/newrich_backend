<?phpnamespace backend\modules\api\controllers;use appxq\sdii\utils\SDUtility;use appxq\sdii\utils\VarDumper;use backend\modules\api\classes\ClsAuth;use backend\modules\api\classes\ClsMember;use common\modules\user\classes\CNAuth;use common\modules\user\models\Profile;use cpn\chanpan\classes\CNMessage;use mdm\admin\models\User;use yii\web\Controller;use yii\web\UploadedFile;class AuthController extends Controller{    public function beforeAction($action)    {        $origin = "*";        if (array_key_exists('HTTP_ORIGIN', $_SERVER)) {            $origin = $_SERVER['HTTP_ORIGIN'];        }        header("Access-Control-Allow-Origin: $origin", true);        header("Access-Control-Allow-Headers: Origin,Content-Type,Authorization,x-access-token,application,uuid,version,platform");        $this->enableCsrfValidation = false;        return true;    }    public function actionSocialLogin(){        $email = \Yii::$app->request->post('email');        $name = \Yii::$app->request->post('name');        $id = \Yii::$app->request->post('id');        $link = \Yii::$app->request->post('link');        $linkCurrent = 'Newrich'.Date('dmYHis').time().rand(1000000,999999999);        $profile = Profile::find()->where('link=:link',[            ':link' => $link        ])->one();        $user = ClsAuth::getUserByEmail($email);        if($user){            $member = ClsMember::getMemberById($user->id, true);            return CNMessage::getSuccess("Success", $member);        }else{            $data = [                'email'=>$email,                'password'=>SDUtility::getMillisecTime(),                'firstname'=>$name,                'lastname'=>$name,                'name'=>$name,                'member_id'=>'newrich',                'linkCurrent'=>$linkCurrent,                'member_type'=>'B2B',                'parent_id'=>$profile->user_id,                'tel'=>''            ];            $data = ClsAuth::saveUser($data);            if($data['status'] == 'success'){                $member = ClsMember::getMemberById($data['data']['id'], true);                return CNMessage::getSuccess("Login สำเร็จ", $member);            }else{                return CNMessage::getError("Error กรุณาตรวจสอบข้อมูลของท่าน", $data);            }        }    }    public function actionRegister()    {        $email = \Yii::$app->request->post('email');        $password = \Yii::$app->request->post('password');        $firstname = \Yii::$app->request->post('firstname');        $lastname = \Yii::$app->request->post('lastname');        $member_id = \Yii::$app->request->post('member_id');        $member_type = \Yii::$app->request->post('member_type');        $site = \Yii::$app->request->post('site');        $tel = \Yii::$app->request->post('tel');        $link = \Yii::$app->request->post('link');        $linkCurrent = 'Newrich'.Date('dmYHis').time().rand(1000000,999999999);        $profile = Profile::find()->where('link=:link',[            ':link' => $link        ])->one();        if(ClsAuth::checkEmail($email)){            return CNMessage::getError("Email {$email} ถูกใช้งานแล้ว");        }        $data = [            'email'=>$email,            'password'=>$password,            'firstname'=>$firstname,            'lastname'=>$lastname,            'name'=>"{$firstname} {$lastname}",            'member_id'=>$member_id,            'linkCurrent'=>$linkCurrent,            'member_type'=>$member_type,            'parent_id'=>isset($profile->user_id)?$profile->user_id:'',            'tel'=>$tel,            'sitecode'=>$site,        ];        $data = ClsAuth::saveUser($data);        if($data['status'] == 'success'){            return CNMessage::getSuccess("สมัครสมาชิกสำเร็จ");        }else{            return CNMessage::getError("Error กรุณาตรวจสอบข้อมูลของท่าน");        }    }    public function actionLogin()    {        $username = \Yii::$app->request->post('username');        $password = \Yii::$app->request->post('password');        $login = ClsAuth::Login($username, $password);        if($login['status']=='success'){            $member = ClsMember::getMemberById($login['data']['id'], true);            return CNMessage::getSuccess("Success", $member);        }else{            return CNMessage::getError("ไม่พบผู้ใช้งาน");        }    }    public function actionGetProfile()    {        $token = \Yii::$app->request->headers->get('x-access-token');        if(!$token){            return CNMessage::getError("Error", "คุณไม่มีสิทธิ์ใช้งานส่วนนี้");        }        $totalStatus = \Yii::$app->request->get('total',true);        $user = ClsAuth::getUserByToken($token);        $member = ClsMember::getMemberById($user->id, true, $totalStatus);        return CNMessage::getSuccess("Success", $member);    }    public function actionMyProfile()    {            $token = \Yii::$app->request->headers->get('x-access-token');            $totalStatus = \Yii::$app->request->get('total',true);            $user = ClsAuth::getUserByToken($token);            //            $profile = Profile::find()->where('user_id=:user_id',[                ':user_id' => $user['id']            ])->one();            return CNMessage::getSuccess("Success", $profile);    }    public function actionChangePassword(){        $token = \Yii::$app->request->headers->get('x-access-token');        if(!$token){            return CNMessage::getError("Error", "คุณไม่มีสิทธิ์ใช้งานส่วนนี้");        }        $user = ClsAuth::getUserByToken($token);        if(!$user){            return CNMessage::getError("Error", "ไม่พบผู้ใช้งาน");        }        $password = \Yii::$app->request->post('password');        $newpassword = \Yii::$app->request->post('new_password');//        $user->password = $user->setPassword($newpassword);//        if($user->save()){//            return CNMessage::getSuccess("Success",'เปลี่ยนรหัสผ่านสำเร็จ');//        }else{//            return CNMessage::getError("Success",'เปลี่ยนรหัสผ่านไม่สำเร็จเนื่องจาก',$user->errors);//        }        if (\Yii::$app->getSecurity()->validatePassword($password, $user->password_hash)) {            $user->password = $user->setPassword($newpassword);            if($user->save()){                return CNMessage::getSuccess("Success",'เปลี่ยนรหัสผ่านสำเร็จ');            }else{                return CNMessage::getError("Success",'เปลี่ยนรหัสผ่านไม่สำเร็จเนื่องจาก',$user->errors);            }        } else {            return CNMessage::getError("Success",'รหัสผ่านปัจจุบันไม่ถูกต้อง');        }    }    public function actionUpdateMyProfile()    {       if(isset($_POST) && !empty($_POST)){           $token = \Yii::$app->request->headers->get('x-access-token');           $user = ClsAuth::getUserByToken($token);           $profile = Profile::find()               ->where('user_id=:user_id',[               ':user_id' => $user->id           ])->one();           $name = \Yii::$app->request->post('name');           $member_id = \Yii::$app->request->post('member_id');           $member_type = \Yii::$app->request->post('member_type');           $tel = \Yii::$app->request->post('tel');           $profileDetail = \Yii::$app->request->post('profile');           if($name == 'undefined'){$name = '';}           if($member_id == 'undefined'){$member_id = '';}           if($member_type == 'undefined'){$member_type = '';}           if($tel == 'undefined'){$tel = '';}           //upload image           $image = UploadedFile::getInstancesByName('image');           $dataImage = "";           if($image){               $file = $image[0];               $realFileName = \appxq\sdii\utils\SDUtility::getMillisecTime();               $folder = "/web/uploads/";               $path = \Yii::getAlias('@storage') . "{$folder}";               $type = $file->extension;               $filePath = "{$path}/{$realFileName}.{$type}";               if ($file->saveAs("{$filePath}")) {                   $fileName = "{$realFileName}.{$type}";                   $dataImage = $fileName;                   try{                       $sql="update profile set avatar_path=:image where user_id=:user_id";                       $params=[':image'=>$dataImage, ':user_id'=>$user->id];                       \Yii::$app->db->createCommand($sql, $params)->execute();                   }catch (\Exception $ex){}               }           }else{               $dataImage = isset($profile->avatar_path)?$profile->avatar_path:'';           }           $profile->name = $name;           $profile->member_id = $member_id;           $profile->member_type = $member_type;           $profile->tel = $tel;           $profile->profile = $profileDetail;           if($profile->save()){               //return $dataImage;               $storageUrl = isset(\Yii::$app->params['storageUrl'])?\Yii::$app->params['storageUrl']:'';               $avatar_path = "{$storageUrl}/uploads/{$dataImage}";               return CNMessage::getSuccess("แก้ไขโปรไฟล์สำเร็จ",['image'=>$avatar_path]);           }else{               return CNMessage::getError("Error", $profile->errors);           }       }    }}