<?phpnamespace backend\modules\api\controllers;use appxq\sdii\utils\SDdate;use appxq\sdii\utils\VarDumper;use backend\modules\api\classes\ClsAuth;use common\modules\user\models\Profile;use cpn\chanpan\classes\CNMessage;use yii\helpers\Json;use yii\web\Controller;class OrderController extends Controller{    private $user_id;    public function beforeAction($action)    {        header('Access-Control-Allow-Origin: *');        header("Access-Control-Allow-Headers: Origin,Content-Type,Authorization,x-access-token,application,uuid,version,platform");        $this->enableCsrfValidation = false;        $token = \Yii::$app->request->headers->get('x-access-token');        if(!$token){            return CNMessage::getError("Error", "คุณไม่มีสิทธิ์ใช้งานส่วนนี้");        }        $user = ClsAuth::getUserByToken($token);        if(!$user){            return CNMessage::getError("Error", "ไม่พบผู้ใช้งาน");        }        $this->setUserId($user);        return true;    }    private function setUserId($user){        $this->user_id = $user->id;        return $this;    }    public function getUserId(){        return $this->user_id;    }    public function actionIndex(){        $year = date('Y');        $output = [];        $datas = [            ['id'=>'01', 'name'=>"ม.ค.", 'stdate'=>"{$year}-01-01", 'endate'=>"{$year}-01-31"],            ['id'=>'02', 'name'=>"ก.พ.", 'stdate'=>"{$year}-02-01", 'endate'=>"{$year}-02-29"],            ['id'=>'03', 'name'=>"มี.ค.", 'stdate'=>"{$year}-03-01", 'endate'=>"{$year}-03-31"],            ['id'=>'04', 'name'=>"เม.ย.", 'stdate'=>"{$year}-04-01", 'endate'=>"{$year}-04-30"],            ['id'=>'05', 'name'=>"พ.ค.", 'stdate'=>"{$year}-05-01", 'endate'=>"{$year}-05-31"],            ['id'=>'06', 'name'=>"มิ.ย.", 'stdate'=>"{$year}-06-01", 'endate'=>"{$year}-06-30"],            ['id'=>'07', 'name'=>"ก.ค.", 'stdate'=>"{$year}-07-01", 'endate'=>"{$year}-07-31"],            ['id'=>'08', 'name'=>"ส.ค.", 'stdate'=>"{$year}-08-01", 'endate'=>"{$year}-08-31"],            ['id'=>'09', 'name'=>"ก.ย.", 'stdate'=>"{$year}-09-01", 'endate'=>"{$year}-09-30"],            ['id'=>'10', 'name'=>"ต.ค.", 'stdate'=>"{$year}-10-01", 'endate'=>"{$year}-10-31"],            ['id'=>'11', 'name'=>"พ.ย.", 'stdate'=>"{$year}-11-01", 'endate'=>"{$year}-11-30"],            ['id'=>'12', 'name'=>"ธ.ค.", 'stdate'=>"{$year}-12-01", 'endate'=>"{$year}-12-31"],        ];        $user_id = Profile::findOne($this->user_id);        if(isset($user_id)){            $user_id = $user_id['member_id'];        }        //return Json::encode($user_id);        //VarDumper::dump($user_id);        foreach($datas as $k=>$v){            $totalPrice=0;//ราคา order            $totalScore=0;//คะแนน            $percent = 0; //รายรับ            $sql="SELECT * FROM orders WHERE user_id=:user_id AND create_date BETWEEN :stdaate AND :endate";            $params=[                ':user_id'=>$user_id,                ':stdaate'=>$v['stdate']." 00:00:00",                ':endate'=>$v['endate']." 23:59:59"            ];            $money = \Yii::$app->db->createCommand($sql,$params)->queryAll();            if($money){                foreach($money as $k2=>$m){                    $totalPrice += $m['order'];                    $totalScore += $m['score'];                    $percent += $m['percent'];                }                //return CNMessage::getSuccess("S",$params);                $output[]=[                    'id'=>$v['id'],                    'title'=>$v['name'],                    'subheader'=>"รายรับ : ".number_format($percent)." ฿",                    'description'=>"คะแนน : ".number_format($totalScore)." PV",                    'order'=>number_format($totalPrice),                    'icon'=>''                ];            }        }        return CNMessage::getSuccess("Success", $output);    }}